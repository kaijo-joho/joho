<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKLCH Palette Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }
        
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none; width: 100%; height: 12px; border-radius: 6px;
            outline: none; margin: 0; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 12px; background: transparent; border-radius: 6px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #ffffff; border: 2px solid #475569; margin-top: -5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        input[type=range]:focus::-webkit-slider-thumb {
            transform: scale(1.1); border-color: #3b82f6;
        }

        .loader {
            border: 2px solid #f3f3f3; border-top: 2px solid currentColor; border-radius: 50%;
            width: 16px; height: 16px; animation: spin 1s linear infinite; display: none;
        }
        .loading .loader { display: inline-block; }
        .loading .btn-text { display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Main Tab Buttons - Card Style */
        .main-tab-btn {
            @apply px-6 py-3 text-sm font-bold text-slate-500 border border-transparent border-b-0 rounded-t-lg transition-all flex items-center gap-2 relative top-[1px];
        }
        .main-tab-btn:hover {
            @apply text-slate-700 bg-slate-50;
        }
        .main-tab-btn.active {
            @apply bg-white text-indigo-600 border-slate-200 border-b-white z-10 shadow-[0_-2px_4px_rgba(0,0,0,0.02)];
        }

        /* Sub Tab Buttons - Pill/Toggle Style */
        .sub-tab-btn {
            @apply flex-1 py-2 text-[10px] sm:text-xs font-bold text-slate-600 rounded-md transition-all flex justify-center items-center gap-1 leading-tight text-center px-2 border border-transparent;
        }
        .sub-tab-btn:hover:not(.active) {
            @apply bg-slate-200;
        }
        .sub-tab-btn.active {
            @apply bg-slate-800 text-white shadow-md ring-1 ring-slate-900/5;
        }
        
        .grid-cell:hover {
            transform: scale(1.1); z-index: 20;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        
        /* Compact Value Display Table */
        .val-table { width: 100%; font-size: 10px; }
        .val-table td { padding: 2px 0; }
        .val-label { font-weight: bold; color: #94a3b8; width: 35px; }
        .val-data { font-family: 'JetBrains Mono', monospace; color: #334155; text-align: right; letter-spacing: -0.02em; }
    </style>
</head>
<body class="pb-40">

    <header class="bg-white border-b border-slate-200 py-4 shadow-sm sticky top-0 z-40">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <i data-lucide="grid" class="w-6 h-6 text-indigo-500"></i>
                OKLCH Palette Generator
            </h1>
            <div id="toast" class="bg-slate-800 text-white px-4 py-2 rounded shadow-lg text-sm font-bold opacity-0 transition-opacity duration-300 pointer-events-none fixed top-20 right-4 z-[100]">
                Copied!
            </div>
        </div>
    </header>

    <main class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <section class="bg-white rounded-xl p-6 shadow-sm border border-slate-200">
            <div class="flex flex-col lg:flex-row gap-8 items-start">
                
                <div class="flex-grow w-full lg:w-auto">
                    
                    <div class="flex border-b border-slate-200 mb-6 gap-2 px-1">
                        <button id="main-tab-editor" class="main-tab-btn active" onclick="switchMainView('editor')">
                            <i data-lucide="edit-3" class="w-4 h-4"></i> Color Editor
                        </button>
                        <button id="main-tab-stock" class="main-tab-btn" onclick="switchMainView('stock')">
                            <i data-lucide="bookmark" class="w-4 h-4"></i> Color Stock
                        </button>
                    </div>

                    <div id="view-editor" class="animate-fade-in">
                        <div class="flex flex-col md:flex-row gap-8 items-start">
                            <div class="flex-shrink-0 w-full md:w-48 flex flex-col gap-3">
                                <div class="w-full aspect-square rounded-2xl shadow-inner bg-slate-200 border border-slate-200 relative group overflow-hidden">
                                    <div id="base-swatch" class="w-full h-full transition-colors duration-200"></div>
                                    <div class="absolute inset-0 bg-black/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2 backdrop-blur-[1px]">
                                        <button onclick="copyCurrentBaseColor()" class="bg-white text-slate-700 hover:text-indigo-600 px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition-transform active:scale-95 flex items-center gap-1">
                                            <i data-lucide="copy" class="w-3 h-3"></i> Copy
                                        </button>
                                        <button onclick="addCurrentToStock()" class="bg-slate-800 text-white hover:bg-slate-700 p-1.5 rounded-lg shadow-sm transition-transform active:scale-95" title="Add to Stock">
                                            <i data-lucide="plus" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="bg-slate-50 rounded-lg border border-slate-200 p-3">
                                    <table class="val-table">
                                        <tr><td class="val-label">LCH</td><td id="disp-oklch" class="val-data">--</td></tr>
                                        <tr><td class="val-label">HEX</td><td id="disp-hex" class="val-data">--</td></tr>
                                        <tr><td class="val-label">RGB</td><td id="disp-rgb" class="val-data">--</td></tr>
                                        <tr><td class="val-label">HSL</td><td id="disp-hsl" class="val-data">--</td></tr>
                                        <tr><td class="val-label">HSV</td><td id="disp-hsv" class="val-data">--</td></tr>
                                    </table>
                                </div>
                            </div>

                            <div class="flex-grow w-full">
                                <div class="flex p-1.5 gap-4 bg-slate-100 rounded-lg mb-6 overflow-x-auto border border-slate-200">
                                    <button id="sub-tab-oklch" class="sub-tab-btn active" onclick="switchSubTab('oklch')">OKLCH</button>
                                    <button id="sub-tab-rgb" class="sub-tab-btn" onclick="switchSubTab('rgb')">RGB / Hex</button>
                                    <button id="sub-tab-hsl" class="sub-tab-btn" onclick="switchSubTab('hsl')">HSL / HSV</button>
                                    <button id="sub-tab-ai" class="sub-tab-btn" onclick="switchSubTab('ai')"><i data-lucide="sparkles" class="w-3 h-3 text-amber-500"></i> AI</button>
                                </div>

                                <div id="panel-oklch" class="space-y-5">
                                    <div class="flex items-center gap-3">
                                        <label class="w-8 text-xs font-bold text-slate-500 text-right">L</label>
                                        <div class="flex-1"><input type="range" id="input-l" min="0" max="1" step="0.001"></div>
                                        <input type="number" id="num-l" min="0" max="1" step="0.001" class="w-20 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <label class="w-8 text-xs font-bold text-slate-500 text-right">C</label>
                                        <div class="flex-1"><input type="range" id="input-c" min="0" max="0.37" step="0.001"></div>
                                        <input type="number" id="num-c" min="0" max="0.37" step="0.001" class="w-20 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <label class="w-8 text-xs font-bold text-slate-500 text-right">H</label>
                                        <div class="flex-1"><input type="range" id="input-h" min="0" max="360" step="0.1"></div>
                                        <input type="number" id="num-h" min="0" max="360" step="0.1" class="w-20 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                </div>

                                <div id="panel-rgb" class="hidden space-y-5">
                                    <div class="flex items-center gap-3 mb-2">
                                        <label class="w-8 text-xs font-bold text-slate-500 text-right">#</label>
                                        <div class="relative flex-1">
                                            <input type="text" id="input-hex" class="w-full pl-6 pr-3 py-1.5 border border-slate-300 rounded-lg font-mono text-sm focus:ring-2 focus:ring-blue-500 outline-none uppercase" placeholder="225386" maxlength="7">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">#</span>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <label class="w-8 text-xs font-bold text-slate-500 text-right">R</label>
                                        <div class="flex-1"><input type="range" id="input-r" min="0" max="255" step="1"></div>
                                        <input type="number" id="num-r" min="0" max="255" step="1" class="w-20 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <label class="w-8 text-xs font-bold text-slate-500 text-right">G</label>
                                        <div class="flex-1"><input type="range" id="input-g" min="0" max="255" step="1"></div>
                                        <input type="number" id="num-g" min="0" max="255" step="1" class="w-20 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <label class="w-8 text-xs font-bold text-slate-500 text-right">B</label>
                                        <div class="flex-1"><input type="range" id="input-b" min="0" max="255" step="1"></div>
                                        <input type="number" id="num-b" min="0" max="255" step="1" class="w-20 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                    </div>
                                </div>

                                <div id="panel-hsl" class="hidden space-y-5">
                                    
                                    <div class="flex bg-slate-100 p-1 rounded-lg">
                                        <button id="btn-show-hsl" onclick="setHslHsvMode('hsl')" class="flex-1 py-1.5 text-xs font-bold rounded shadow-sm bg-white text-indigo-600 transition-all">HSL</button>
                                        <button id="btn-show-hsv" onclick="setHslHsvMode('hsv')" class="flex-1 py-1.5 text-xs font-bold rounded text-slate-500 hover:text-slate-700 transition-all">HSV</button>
                                    </div>

                                    <div id="group-hsl" class="space-y-5 animate-fade-in">
                                        <div class="flex items-center gap-3">
                                            <label class="w-8 text-xs font-bold text-slate-400 text-right">H</label>
                                            <div class="flex-1"><input type="range" id="input-hsl-h" min="0" max="360" step="1"></div>
                                            <input type="number" id="num-hsl-h" min="0" max="360" step="1" class="w-16 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <label class="w-8 text-xs font-bold text-slate-400 text-right">S</label>
                                            <div class="flex-1"><input type="range" id="input-hsl-s" min="0" max="100" step="1"></div>
                                            <input type="number" id="num-hsl-s" min="0" max="100" step="1" class="w-16 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <label class="w-8 text-xs font-bold text-slate-400 text-right">L</label>
                                            <div class="flex-1"><input type="range" id="input-hsl-l" min="0" max="100" step="1"></div>
                                            <input type="number" id="num-hsl-l" min="0" max="100" step="1" class="w-16 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                        </div>
                                    </div>

                                    <div id="group-hsv" class="hidden space-y-5 animate-fade-in">
                                        <div class="flex items-center gap-3">
                                            <label class="w-8 text-xs font-bold text-slate-400 text-right">H</label>
                                            <div class="flex-1"><input type="range" id="input-hsv-h" min="0" max="360" step="1"></div>
                                            <input type="number" id="num-hsv-h" min="0" max="360" step="1" class="w-16 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <label class="w-8 text-xs font-bold text-slate-400 text-right">S</label>
                                            <div class="flex-1"><input type="range" id="input-hsv-s" min="0" max="100" step="1"></div>
                                            <input type="number" id="num-hsv-s" min="0" max="100" step="1" class="w-16 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <label class="w-8 text-xs font-bold text-slate-400 text-right">V</label>
                                            <div class="flex-1"><input type="range" id="input-hsv-v" min="0" max="100" step="1"></div>
                                            <input type="number" id="num-hsv-v" min="0" max="100" step="1" class="w-16 text-xs font-mono border border-slate-300 rounded px-1 py-1 text-center focus:ring-2 focus:ring-blue-500 outline-none">
                                        </div>
                                    </div>
                                </div>

                                <div id="panel-ai" class="hidden space-y-6">
                                    <div class="bg-indigo-50/50 rounded-lg border border-indigo-100 p-5">
                                        <label class="block text-xs font-bold text-indigo-900 mb-2">テーマからカラーパレットを生成</label>
                                        <div class="flex gap-2 mb-4">
                                            <input type="text" id="theme-input" placeholder="例: 雨上がりの紫陽花、サイバーパンクな夜" class="flex-1 px-4 py-2 text-sm border border-slate-200 shadow-sm rounded-lg focus:ring-2 focus:ring-indigo-400 outline-none bg-white">
                                            <button id="generate-palette-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-sm transition-transform active:scale-95 flex items-center gap-2 min-w-[100px] justify-center">
                                                <span class="btn-text">生成</span>
                                                <div class="loader border-t-white"></div>
                                            </button>
                                        </div>
                                        <div id="ai-error-message" class="text-red-500 text-xs mb-2 hidden font-bold"></div>
                                        <div id="ai-palette-wrapper" class="hidden">
                                            <p class="text-[10px] text-slate-500 mb-2 font-bold">クリックして基準色に設定:</p>
                                            <div id="palette-ai" class="flex flex-wrap gap-3"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="view-stock" class="hidden animate-fade-in">
                        <div class="flex flex-col gap-4">
                             <div class="flex gap-2 items-center p-3 bg-slate-50 rounded-lg border border-slate-200">
                                <div class="relative w-40">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs font-bold">#</span>
                                    <input type="text" id="manual-hex" placeholder="Manual Add" class="w-full pl-6 pr-3 py-1.5 text-xs rounded border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-400 uppercase" maxlength="7">
                                </div>
                                <button onclick="addManualColor()" class="bg-indigo-600 text-white p-1.5 rounded hover:bg-indigo-700 transition-colors shadow-sm">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                                <div class="flex-1"></div>
                                <button onclick="openCssModal('stock')" class="flex items-center gap-1 bg-white border border-indigo-200 text-indigo-700 text-xs font-bold py-1.5 px-4 rounded hover:bg-indigo-50 transition-colors shadow-sm">
                                    <i data-lucide="code" class="w-3 h-3"></i> CSS (Stock Only)
                                </button>
                            </div>

                            <div id="stock-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 min-h-[200px]">
                                <div id="empty-stock-msg" class="col-span-full flex flex-col items-center justify-center text-slate-400 py-12 border-2 border-dashed border-slate-200 rounded-lg bg-slate-50/50">
                                    <i data-lucide="inbox" class="w-10 h-10 mb-2 opacity-30"></i>
                                    <span class="text-xs">色がストックされていません</span>
                                    <span class="text-[10px] mt-1 opacity-60">グリッド内の [+] ボタンで追加できます</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 w-full lg:w-48 border-l border-slate-100 lg:pl-6 space-y-6 pt-4 lg:pt-0">
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-2">出力形式 (Format)</label>
                        <select id="format-select" onchange="updateFormat(this.value)" class="w-full text-xs font-bold p-2 border border-slate-300 rounded-md focus:ring-blue-500 bg-white cursor-pointer outline-none">
                            <option value="oklch">OKLCH</option>
                            <option value="hex">HEX (#...)</option>
                            <option value="rgb">RGB (...)</option>
                            <option value="hsl">HSL (...)</option>
                            <option value="hsv">HSV (...)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-2">表示モード</label>
                        <div class="grid grid-cols-3 gap-2 h-14">
                            <button id="btn-mode-fill" onclick="setDisplayMode('fill')" class="rounded-lg border border-slate-200 text-xs font-bold shadow-sm transition-all flex flex-col items-center justify-center leading-tight">
                                <span>背景色</span>
                            </button>
                            <button id="btn-mode-light" onclick="setDisplayMode('light')" class="bg-white rounded-lg border border-slate-200 text-xs font-bold shadow-sm transition-all flex flex-col items-center justify-center leading-tight">
                                <span>文字色</span>
                                <span class="text-[9px] opacity-70 scale-90">(ライト)</span>
                            </button>
                            <button id="btn-mode-dark" onclick="setDisplayMode('dark')" class="bg-slate-900 rounded-lg border border-slate-700 text-xs font-bold shadow-sm transition-all flex flex-col items-center justify-center leading-tight">
                                <span>文字色</span>
                                <span class="text-[9px] opacity-70 scale-90">(ダーク)</span>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-2">横軸の色数</label>
                        <div class="flex items-center gap-2">
                            <button id="btn-dec" class="w-8 h-8 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold text-lg leading-none">-</button>
                            <input type="number" id="input-count" value="16" min="3" max="36" class="flex-1 text-center py-1 border-slate-300 rounded-md focus:ring-blue-500 border font-mono font-bold text-slate-700 outline-none">
                            <button id="btn-inc" class="w-8 h-8 rounded-lg bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold text-lg leading-none">+</button>
                        </div>
                        <p id="mode-label" class="text-[10px] text-slate-400 mt-2 font-bold bg-slate-50 px-2 py-1 rounded inline-block w-full text-center">...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="grid-section">
            <div class="mb-4 flex items-center justify-between border-b border-slate-100 pb-2">
                <h2 class="text-lg font-bold text-slate-800">カラーグリッド</h2>
                <button onclick="openCssModal('grid')" class="flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold py-1.5 px-3 rounded-lg transition-colors shadow-sm">
                    <i data-lucide="code" class="w-3 h-3"></i>
                    CSS (Grid Only)
                </button>
            </div>
            <div class="overflow-x-auto pb-12">
                <div id="main-grid" class="min-w-max grid gap-1">
                    </div>
            </div>
        </section>
    </main>

    <div id="css-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 modal-overlay" onclick="closeCssModal()"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[85vh] h-[80vh] flex flex-col transform transition-all">
                <div class="flex justify-between items-center p-4 border-b border-slate-100">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="file-code" class="w-5 h-5 text-indigo-500"></i>
                        <span id="css-modal-title">CSS Output</span>
                    </h3>
                    <button onclick="closeCssModal()" class="text-slate-400 hover:text-slate-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="p-0 flex-1 overflow-hidden relative group">
                    <textarea id="css-output" class="w-full h-full p-4 font-mono text-xs text-slate-600 bg-slate-50 outline-none resize-none" readonly spellcheck="false"></textarea>
                    <button onclick="copyCss()" class="absolute top-4 right-4 bg-white/90 hover:bg-white text-slate-700 shadow-md border border-slate-200 px-3 py-1.5 rounded-md text-xs font-bold transition-all opacity-0 group-hover:opacity-100">
                        Copy All
                    </button>
                </div>
                <div class="p-4 border-t border-slate-100 bg-slate-50 rounded-b-xl text-xs text-slate-500">
                    設定されたフォーマットで書き出されます。
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const apiKey = ""; 
        const STORAGE_KEY = 'oklch-palette-v1';

        // --- Utils ---
        function srgb_transfer_inv(c) { return c <= 0.04045 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4); }
        function srgb_transfer(c) { return c <= 0.0031308 ? 12.92 * c : 1.055 * Math.pow(c, 1/2.4) - 0.055; }
        function clip(v) { return Math.max(0, Math.min(1, v)); }

        function rgbToOklch(r, g, b) {
            r = srgb_transfer_inv(r / 255); g = srgb_transfer_inv(g / 255); b = srgb_transfer_inv(b / 255);
            const l_ = 0.4122214708 * r + 0.5363325363 * g + 0.0514459929 * b;
            const m_ = 0.2119034982 * r + 0.6806995451 * g + 0.1073969566 * b;
            const s_ = 0.0883024619 * r + 0.2817188376 * g + 0.6299787005 * b;
            const l = Math.cbrt(l_), m = Math.cbrt(m_), s = Math.cbrt(s_);
            const L = 0.2104542553 * l + 0.7936177850 * m - 0.0040720468 * s;
            const A = 1.9779984951 * l - 2.4285922050 * m + 0.4505937099 * s;
            const B = 0.0259040371 * l + 0.7827717662 * m - 0.8086757660 * s;
            const C = Math.sqrt(A*A + B*B);
            let H = Math.atan2(B, A) * 180 / Math.PI;
            if (H < 0) H += 360;
            return { l: L, c: C, h: H };
        }

        function oklchToRgb(l, c, h) {
            const H_rad = h * Math.PI / 180;
            const labA = c * Math.cos(H_rad), labB = c * Math.sin(H_rad);
            const l_p = l + 0.3963377774 * labA + 0.2158037573 * labB;
            const m_p = l - 0.1055613458 * labA - 0.0638541728 * labB;
            const s_p = l - 0.0894841775 * labA - 1.2914855480 * labB;
            const l_o = l_p**3, m_o = m_p**3, s_o = s_p**3;
            const x = 4.0767416621 * l_o - 3.3077115913 * m_o + 0.2309699292 * s_o;
            const y = -1.2684380046 * l_o + 2.6097574011 * m_o - 0.3413193965 * s_o;
            const z = -0.0041960863 * l_o - 0.7034186147 * m_o + 1.7076147010 * s_o;
            const r_l = 3.2404542 * x - 1.5371385 * y - 0.4985314 * z;
            const g_l = -0.9692660 * x + 1.8760108 * y + 0.0415560 * z;
            const b_l = 0.0556434 * x - 0.2040259 * y + 1.0572252 * z;
            const r = srgb_transfer(clip(r_l)) * 255;
            const g = srgb_transfer(clip(g_l)) * 255;
            const b = srgb_transfer(clip(b_l)) * 255;
            return { r: Math.round(r), g: Math.round(g), b: Math.round(b) };
        }

        // --- HSL / HSV Conversions ---
        function rgbToHsl(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            if (max === min) { h = s = 0; } 
            else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h * 360, s: s * 100, l: l * 100 };
        }

        function hslToRgb(h, s, l) {
            h /= 360; s /= 100; l /= 100;
            let r, g, b;
            if (s === 0) { r = g = b = l; } 
            else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1; if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
        }

        function rgbToHsv(r, g, b) {
            r /= 255; g /= 255; b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, v = max;
            const d = max - min;
            s = max === 0 ? 0 : d / max;
            if (max === min) { h = 0; } 
            else {
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }
            return { h: h * 360, s: s * 100, v: v * 100 };
        }

        function hsvToRgb(h, s, v) {
            h /= 360; s /= 100; v /= 100;
            let r, g, b;
            const i = Math.floor(h * 6);
            const f = h * 6 - i;
            const p = v * (1 - s);
            const q = v * (1 - f * s);
            const t = v * (1 - (1 - f) * s);
            switch (i % 6) {
                case 0: r = v; g = t; b = p; break;
                case 1: r = q; g = v; b = p; break;
                case 2: r = p; g = v; b = t; break;
                case 3: r = p; g = q; b = v; break;
                case 4: r = t; g = p; b = v; break;
                case 5: r = v; g = p; b = q; break;
            }
            return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
        }

        function rgbToHex(r, g, b) {
            return ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }

        function getFormattedColor(l, c, h, format) {
            let hh = h % 360; if(hh<0) hh+=360;
            const rgb = oklchToRgb(l, c, hh);
            if (format === 'oklch') {
                return `oklch(${l.toFixed(4)} ${c.toFixed(4)} ${hh.toFixed(2)})`;
            } else if (format === 'rgb') {
                return `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            } else if (format === 'hsl') {
                const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
                return `hsl(${Math.round(hsl.h)}, ${Math.round(hsl.s)}%, ${Math.round(hsl.l)}%)`;
            } else if (format === 'hsv') {
                const hsv = rgbToHsv(rgb.r, rgb.g, rgb.b);
                return `hsv(${Math.round(hsv.h)}, ${Math.round(hsv.s)}%, ${Math.round(hsv.v)}%)`;
            } else { // hex
                return '#' + rgbToHex(rgb.r, rgb.g, rgb.b);
            }
        }

        // --- Naming Logic ---
        const hueAnchorsBasic = [
            { h: 20, ja: '赤', en: 'Red' }, { h: 45, ja: '橙', en: 'Orange' }, { h: 70, ja: '黄', en: 'Yellow' },
            { h: 130, ja: '緑', en: 'Green' }, { h: 195, ja: '水色', en: 'Cyan' }, { h: 250, ja: '青', en: 'Blue' },
            { h: 300, ja: '紫', en: 'Purple' }, { h: 340, ja: '桃', en: 'Pink' }
        ];
        const hueAnchorsDetailed = [
            { h: 5, ja: '赤', en: 'Red' }, { h: 30, ja: '橙', en: 'Orange' }, { h: 47.5, ja: '琥珀', en: 'Amber' },
            { h: 67.5, ja: '黄', en: 'Yellow' }, { h: 95, ja: 'ライム', en: 'Lime' }, { h: 125, ja: '緑', en: 'Green' },
            { h: 152.5, ja: 'ミント', en: 'Mint' }, { h: 177.5, ja: '青緑', en: 'Teal' }, { h: 200, ja: 'シアン', en: 'Cyan' },
            { h: 222.5, ja: '空色', en: 'Sky' }, { h: 250, ja: '青', en: 'Blue' }, { h: 275, ja: '藍', en: 'Indigo' },
            { h: 297.5, ja: '紫', en: 'Purple' }, { h: 320, ja: 'マゼンタ', en: 'Magenta' }, { h: 340, ja: '桃', en: 'Pink' }
        ];

        function getDistance(h1, h2) { const d = Math.abs(h1 - h2); return Math.min(d, 360 - d); }
        function lookupName(h, anchors) {
            let p=null, s=null, minD=360, minD2=360;
            for(let a of anchors){
                const d=getDistance(h, a.h);
                if(d<minD){ minD2=minD; s=p; minD=d; p=a; }
                else if(d<minD2){ minD2=d; s=a; }
            }
            return { p, s, minD };
        }

        function resolveColorNames(hues, count) {
            let initialLevel = 'basic';
            if (count > 15) initialLevel = 'hybrid';
            else if (count > 8) initialLevel = 'detailed';

            let names = hues.map(h => {
                let hh = h % 360; if(hh<0) hh+=360;
                let anchors = (initialLevel === 'basic') ? hueAnchorsBasic : hueAnchorsDetailed;
                let res = lookupName(hh, anchors);
                if (initialLevel === 'hybrid') {
                    if (res.minD < 8) return { ja: res.p.ja, en: res.p.en, hue: hh };
                    return { ja: `${res.p.ja}-${res.s.ja}`, en: `${res.p.en}-${res.s.en}`, hue: hh };
                }
                return { ja: res.p.ja, en: res.p.en, hue: hh };
            });

            const groups = {}; names.forEach((n, i) => { if(!groups[n.en]) groups[n.en]=[]; groups[n.en].push(i); });
            Object.keys(groups).forEach(k => { if(groups[k].length > 1) groups[k].forEach(i => {
                let res = lookupName(names[i].hue, hueAnchorsDetailed);
                names[i].en = res.p.en; names[i].ja = res.p.ja;
            })});
            const groups2 = {}; names.forEach((n, i) => { if(!groups2[n.en]) groups2[n.en]=[]; groups2[n.en].push(i); });
            Object.keys(groups2).forEach(k => { if(groups2[k].length > 1) groups2[k].forEach(i => {
                let res = lookupName(names[i].hue, hueAnchorsDetailed);
                names[i].en = `${res.p.en}-${res.s.en}`; names[i].ja = `${res.p.ja}-${res.s.ja}`;
            })});
            const groups3 = {}; names.forEach((n, i) => { if(!groups3[n.en]) groups3[n.en]=[]; groups3[n.en].push(i); });
            Object.keys(groups3).forEach(k => { if(groups3[k].length > 1) groups3[k].forEach(i => {
                names[i].en += `-${Math.round(names[i].hue)}`;
            })});
            return names;
        }

        // --- App State ---
        const state = { l: 0.422, c: 0.113, h: 264.00, r: 34, g: 83, b: 134, count: 16, viewMode: 'fill', bgTheme: 'light', outputFormat: 'oklch', hsvMode: 'hsl' };
        const pinnedColors = []; 

        const els = {
            inputL: document.getElementById('input-l'), numL: document.getElementById('num-l'),
            inputC: document.getElementById('input-c'), numC: document.getElementById('num-c'),
            inputH: document.getElementById('input-h'), numH: document.getElementById('num-h'),
            inputR: document.getElementById('input-r'), numR: document.getElementById('num-r'),
            inputG: document.getElementById('input-g'), numG: document.getElementById('num-g'),
            inputB: document.getElementById('input-b'), numB: document.getElementById('num-b'),
            
            // HSL / HSV Inputs
            inputHslH: document.getElementById('input-hsl-h'), numHslH: document.getElementById('num-hsl-h'),
            inputHslS: document.getElementById('input-hsl-s'), numHslS: document.getElementById('num-hsl-s'),
            inputHslL: document.getElementById('input-hsl-l'), numHslL: document.getElementById('num-hsl-l'),
            inputHsvH: document.getElementById('input-hsv-h'), numHsvH: document.getElementById('num-hsv-h'),
            inputHsvS: document.getElementById('input-hsv-s'), numHsvS: document.getElementById('num-hsv-s'),
            inputHsvV: document.getElementById('input-hsv-v'), numHsvV: document.getElementById('num-hsv-v'),
            
            btnShowHsl: document.getElementById('btn-show-hsl'),
            btnShowHsv: document.getElementById('btn-show-hsv'),
            groupHsl: document.getElementById('group-hsl'),
            groupHsv: document.getElementById('group-hsv'),

            swatch: document.getElementById('base-swatch'), 
            dispOklch: document.getElementById('disp-oklch'),
            dispHex: document.getElementById('disp-hex'),
            dispRgb: document.getElementById('disp-rgb'),
            dispHsl: document.getElementById('disp-hsl'),
            dispHsv: document.getElementById('disp-hsv'),

            inputCount: document.getElementById('input-count'), btnInc: document.getElementById('btn-inc'), btnDec: document.getElementById('btn-dec'),
            inputHex: document.getElementById('input-hex'),
            mainGrid: document.getElementById('main-grid'),
            
            btnModeFill: document.getElementById('btn-mode-fill'),
            btnModeLight: document.getElementById('btn-mode-light'),
            btnModeDark: document.getElementById('btn-mode-dark'),

            cssModal: document.getElementById('css-modal'), cssOutput: document.getElementById('css-output'), cssModalTitle: document.getElementById('css-modal-title'),
            stockContainer: document.getElementById('stock-container'), emptyStockMsg: document.getElementById('empty-stock-msg'), manualHex: document.getElementById('manual-hex'),
            btnGen: document.getElementById('generate-palette-btn'), inputTheme: document.getElementById('theme-input'),
            aiWrapper: document.getElementById('ai-palette-wrapper'), pAi: document.getElementById('palette-ai'), errAi: document.getElementById('ai-error-message'),
            modeLabel: document.getElementById('mode-label'), formatSelect: document.getElementById('format-select'),
            
            mainTabEditor: document.getElementById('main-tab-editor'), mainTabStock: document.getElementById('main-tab-stock'),
            viewEditor: document.getElementById('view-editor'), viewStock: document.getElementById('view-stock'),
            
            subTabOklch: document.getElementById('sub-tab-oklch'), subTabRgb: document.getElementById('sub-tab-rgb'), subTabHsl: document.getElementById('sub-tab-hsl'), subTabAi: document.getElementById('sub-tab-ai'),
            panelOklch: document.getElementById('panel-oklch'), panelRgb: document.getElementById('panel-rgb'), panelHsl: document.getElementById('panel-hsl'), panelAi: document.getElementById('panel-ai')
        };

        function saveToLocal() {
            const data = {
                state: state,
                pinnedColors: pinnedColors
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            } catch(e) { console.error("Save failed", e); }
        }

        function loadFromLocal() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if(raw) {
                try {
                    const data = JSON.parse(raw);
                    if(data.state) Object.assign(state, data.state);
                    if(data.pinnedColors && Array.isArray(data.pinnedColors)) {
                        pinnedColors.length = 0;
                        data.pinnedColors.forEach(c => pinnedColors.push(c));
                    }
                    if(!state.count || isNaN(state.count)) state.count = 16;
                    els.formatSelect.value = state.outputFormat;
                    els.inputCount.value = state.count;
                    if(state.hsvMode) setHslHsvMode(state.hsvMode, false);
                } catch(e) { console.error("Load failed", e); }
            }
            syncUI();
        }

        function updateSliderGradients() {
            // OKLCH
            els.inputL.style.background = `linear-gradient(to right, oklch(0 ${state.c} ${state.h}), oklch(1 ${state.c} ${state.h}))`;
            els.inputC.style.background = `linear-gradient(to right, oklch(${state.l} 0 ${state.h}), oklch(${state.l} 0.37 ${state.h}))`;
            els.inputH.style.background = `linear-gradient(to right, 
                oklch(${state.l} ${state.c} 0), oklch(${state.l} ${state.c} 60), oklch(${state.l} ${state.c} 120), 
                oklch(${state.l} ${state.c} 180), oklch(${state.l} ${state.c} 240), oklch(${state.l} ${state.c} 300), oklch(${state.l} ${state.c} 360))`;
            
            // RGB
            els.inputR.style.background = `linear-gradient(to right, rgb(0, ${state.g}, ${state.b}), rgb(255, ${state.g}, ${state.b}))`;
            els.inputG.style.background = `linear-gradient(to right, rgb(${state.r}, 0, ${state.b}), rgb(${state.r}, 255, ${state.b}))`;
            els.inputB.style.background = `linear-gradient(to right, rgb(${state.r}, ${state.g}, 0), rgb(${state.r}, ${state.g}, 255))`;

            // HSL (Approximate gradient)
            const hsl = rgbToHsl(state.r, state.g, state.b);
            els.inputHslH.style.background = `linear-gradient(to right, hsl(0, ${hsl.s}%, ${hsl.l}%), hsl(60, ${hsl.s}%, ${hsl.l}%), hsl(120, ${hsl.s}%, ${hsl.l}%), hsl(180, ${hsl.s}%, ${hsl.l}%), hsl(240, ${hsl.s}%, ${hsl.l}%), hsl(300, ${hsl.s}%, ${hsl.l}%), hsl(360, ${hsl.s}%, ${hsl.l}%))`;
            els.inputHslS.style.background = `linear-gradient(to right, hsl(${hsl.h}, 0%, ${hsl.l}%), hsl(${hsl.h}, 100%, ${hsl.l}%))`;
            els.inputHslL.style.background = `linear-gradient(to right, hsl(${hsl.h}, ${hsl.s}%, 0%), hsl(${hsl.h}, ${hsl.s}%, 50%), hsl(${hsl.h}, ${hsl.s}%, 100%))`;
        
            // HSV (Approximate)
            const hsv = rgbToHsv(state.r, state.g, state.b);
            els.inputHsvH.style.background = `linear-gradient(to right, hsl(0, 100%, 50%), hsl(60, 100%, 50%), hsl(120, 100%, 50%), hsl(180, 100%, 50%), hsl(240, 100%, 50%), hsl(300, 100%, 50%), hsl(360, 100%, 50%))`;
            els.inputHsvS.style.background = `linear-gradient(to right, hsv(${hsv.h}, 0%, ${hsv.v}%), hsv(${hsv.h}, 100%, ${hsv.v}%))`; 
        }

        function updateState(l, c, h) { 
            state.l = parseFloat(l); state.c = parseFloat(c); state.h = parseFloat(h);
            if(isNaN(state.l)) state.l = 0.5; if(isNaN(state.c)) state.c = 0.1; if(isNaN(state.h)) state.h = 0;
            const rgb = oklchToRgb(state.l, state.c, state.h);
            state.r = rgb.r; state.g = rgb.g; state.b = rgb.b;
            saveToLocal();
            syncUI(); 
        }
        
        function updateStateFromRgb(r, g, b) { 
            state.r = parseInt(r); state.g = parseInt(g); state.b = parseInt(b);
            const o = rgbToOklch(state.r, state.g, state.b); 
            state.l = o.l; state.c = o.c; state.h = o.h; 
            saveToLocal();
            syncUI(); 
        }

        function updateStateFromHsl(h, s, l) {
            const rgb = hslToRgb(h, s, l);
            state.r = rgb.r; state.g = rgb.g; state.b = rgb.b;
            const o = rgbToOklch(state.r, state.g, state.b);
            state.l = o.l; state.c = o.c; state.h = o.h;
            saveToLocal();
            syncUI();
        }

        function updateStateFromHsv(h, s, v) {
            const rgb = hsvToRgb(h, s, v);
            state.r = rgb.r; state.g = rgb.g; state.b = rgb.b;
            const o = rgbToOklch(state.r, state.g, state.b);
            state.l = o.l; state.c = o.c; state.h = o.h;
            saveToLocal();
            syncUI();
        }
        
        window.switchMainView = (view) => {
            if(view === 'editor') {
                els.mainTabEditor.classList.add('active'); els.mainTabStock.classList.remove('active');
                els.viewEditor.classList.remove('hidden'); els.viewStock.classList.add('hidden');
            } else {
                els.mainTabEditor.classList.remove('active'); els.mainTabStock.classList.add('active');
                els.viewEditor.classList.add('hidden'); els.viewStock.classList.remove('hidden');
                renderStock();
            }
        };

        window.switchSubTab = (tab) => {
            els.subTabOklch.classList.remove('active'); els.subTabRgb.classList.remove('active'); els.subTabHsl.classList.remove('active'); els.subTabAi.classList.remove('active');
            els.panelOklch.classList.add('hidden'); els.panelRgb.classList.add('hidden'); els.panelHsl.classList.add('hidden'); els.panelAi.classList.add('hidden');

            if(tab === 'oklch') { els.subTabOklch.classList.add('active'); els.panelOklch.classList.remove('hidden'); }
            else if(tab === 'rgb') { els.subTabRgb.classList.add('active'); els.panelRgb.classList.remove('hidden'); }
            else if(tab === 'hsl') { els.subTabHsl.classList.add('active'); els.panelHsl.classList.remove('hidden'); }
            else { els.subTabAi.classList.add('active'); els.panelAi.classList.remove('hidden'); }
        };

        window.setHslHsvMode = (mode, save=true) => {
            state.hsvMode = mode;
            if(mode === 'hsl') {
                els.btnShowHsl.className = "flex-1 py-1.5 text-xs font-bold rounded shadow-sm bg-white text-indigo-600 transition-all";
                els.btnShowHsv.className = "flex-1 py-1.5 text-xs font-bold rounded text-slate-500 hover:text-slate-700 transition-all";
                els.groupHsl.classList.remove('hidden');
                els.groupHsv.classList.add('hidden');
            } else {
                els.btnShowHsl.className = "flex-1 py-1.5 text-xs font-bold rounded text-slate-500 hover:text-slate-700 transition-all";
                els.btnShowHsv.className = "flex-1 py-1.5 text-xs font-bold rounded shadow-sm bg-white text-indigo-600 transition-all";
                els.groupHsl.classList.add('hidden');
                els.groupHsv.classList.remove('hidden');
            }
            if(save) saveToLocal();
        };

        window.setBaseColor = (l, c, h) => {
            state.l = l; state.c = c; state.h = h;
            const rgb = oklchToRgb(l, c, h);
            state.r = rgb.r; state.g = rgb.g; state.b = rgb.b;
            saveToLocal();
            syncUI();
        };

        window.setDisplayMode = (type) => { 
            if (type === 'fill') {
                state.viewMode = 'fill';
            } else if (type === 'light') {
                state.viewMode = 'text';
                state.bgTheme = 'light';
            } else if (type === 'dark') {
                state.viewMode = 'text';
                state.bgTheme = 'dark';
            }
            saveToLocal();
            syncUI(); 
        };

        window.updateFormat = (val) => { 
            state.outputFormat = val; 
            saveToLocal();
            syncUI(); 
        };

        window.copyCurrentBaseColor = () => {
            copyColor(state.l, state.c, state.h);
        };

        window.addCurrentToStock = () => {
            addToStock(state.l, state.c, state.h);
        };

        window.addToStock = (l, c, h) => {
            const hNorm = ((h % 360) + 360) % 360;
            const isDuplicate = pinnedColors.some(p => 
                Math.abs(p.l - l) < 0.0001 && 
                Math.abs(p.c - c) < 0.0001 && 
                getDistance(p.h, hNorm) < 0.05 
            );

            if (isDuplicate) {
                const t = document.getElementById('toast');
                t.textContent = 'Already Stocked!';
                t.style.opacity = '1';
                setTimeout(()=>t.style.opacity='0', 2000);
                return;
            }

            const hInfo = lookupName(hNorm, hueAnchorsDetailed);
            const lPerc = Math.round(l*100);
            const defaultName = `${hInfo.p.en.toLowerCase()}-${lPerc}`;
            pinnedColors.push({ l, c, h: hNorm, name: defaultName });
            saveToLocal();
            renderStock();
            const t = document.getElementById('toast');
            t.textContent = 'Stocked!';
            t.style.opacity = '1';
            setTimeout(()=>t.style.opacity='0', 2000);
        };

        window.addManualColor = () => {
            let hex = els.manualHex.value.trim();
            if(!hex) return;
            if(!hex.startsWith('#')) hex = '#'+hex;
            if(hex.length === 4) hex = '#' + hex[1]+hex[1]+hex[2]+hex[2]+hex[3]+hex[3];
            if(hex.length !== 7) return;
            const r = parseInt(hex.substring(1,3),16), g = parseInt(hex.substring(3,5),16), b = parseInt(hex.substring(5,7),16);
            if(!isNaN(r)) {
                const o = rgbToOklch(r,g,b);
                const hNorm = ((o.h % 360) + 360) % 360;
                const hInfo = lookupName(hNorm, hueAnchorsDetailed);
                const defaultName = `custom-${hInfo.p.en.toLowerCase()}`;
                
                const isDuplicate = pinnedColors.some(p => Math.abs(p.l - o.l) < 0.0001 && Math.abs(p.c - o.c) < 0.0001 && getDistance(p.h, hNorm) < 0.05);
                if (isDuplicate) {
                     const t = document.getElementById('toast'); t.textContent = 'Already Stocked!'; t.style.opacity = '1'; setTimeout(()=>t.style.opacity='0', 2000); return;
                }

                pinnedColors.push({ l:o.l, c:o.c, h:hNorm, name: defaultName });
                saveToLocal();
                renderStock();
                els.manualHex.value = '';
                switchMainView('stock');
            }
        };

        window.removeStock = (idx) => { 
            pinnedColors.splice(idx, 1); 
            saveToLocal();
            renderStock(); 
        };
        window.updateStockName = (idx, newName) => { 
            pinnedColors[idx].name = newName; 
            saveToLocal();
        };

        window.copyColor = (l, c, h) => {
            const hNorm = ((h % 360) + 360) % 360;
            const txt = getFormattedColor(l, c, hNorm, state.outputFormat);
            navigator.clipboard.writeText(txt);
            const t = document.getElementById('toast');
            t.textContent = `Copied ${state.outputFormat.toUpperCase()}!`;
            t.style.opacity = '1';
            setTimeout(()=>t.style.opacity='0', 2000);
        }

        function renderStock() {
            if(pinnedColors.length === 0) {
                els.stockContainer.innerHTML = '';
                els.stockContainer.appendChild(els.emptyStockMsg);
                els.emptyStockMsg.classList.remove('hidden');
                return;
            }
            els.emptyStockMsg.classList.add('hidden');
            els.stockContainer.innerHTML = pinnedColors.map((c, i) => {
                let displayVal = '';
                let hh = c.h % 360; if(hh<0) hh+=360;
                displayVal = getFormattedColor(c.l, c.c, hh, state.outputFormat);
                
                const bgStyle = `oklch(${c.l} ${c.c} ${c.h})`;
                const isLight = c.l > 0.6;
                const txtColor = isLight ? 'text-slate-800' : 'text-white';
                return `
                <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden flex flex-col group">
                    <div class="h-16 relative flex items-center justify-center cursor-pointer" style="background-color: ${bgStyle};" onclick="copyColor(${c.l}, ${c.c}, ${c.h})">
                        <span class="${txtColor} text-[10px] opacity-0 group-hover:opacity-100 font-bold bg-black/10 px-1 rounded backdrop-blur-[1px]">Copy</span>
                        <button onclick="event.stopPropagation(); removeStock(${i})" class="absolute top-1 right-1 text-white/70 hover:text-red-500 bg-black/20 hover:bg-white rounded-full p-0.5 transition-colors"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>
                    <div class="p-2 bg-white">
                        <input type="text" value="${c.name}" onchange="updateStockName(${i}, this.value)" class="w-full text-xs border-b border-transparent focus:border-indigo-300 outline-none text-slate-700 font-bold mb-1 bg-transparent truncate">
                        <div class="text-[9px] font-mono text-slate-400 truncate" title="${displayVal}">${displayVal}</div>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        function generateLightnessSteps(baseL) {
            const stepsCount = 10;
            const maxL = 1.0;
            if (baseL >= 0.99) { const arr=[]; for(let i=0;i<stepsCount;i++) arr.push(1.0-(i*0.1)); return {steps:arr, baseIndex:0}; }
            let baseIndex = Math.round((1.0 - baseL) * 9);
            if(baseIndex<1) baseIndex=1; if(baseIndex>=stepsCount) baseIndex=stepsCount-1;
            const stepSize = (maxL - baseL) / baseIndex;
            const steps=[]; for(let i=0;i<stepsCount;i++){ let v=maxL-(i*stepSize); if(v>1)v=1;if(v<0)v=0; steps.push(v); }
            return {steps, baseIndex};
        }

        // --- FIXED: Added missing renderGrid function ---
        function renderGrid() {
            els.mainGrid.style.gridTemplateColumns = `repeat(${state.count}, minmax(80px, 1fr))`;
            let html = '';
            const hueStep = 360 / state.count;
            const { steps: lSteps, baseIndex } = generateLightnessSteps(state.l);

            const hues = []; for(let c=0; c<state.count; c++) hues.push((state.h + (c*hueStep)));
            const names = resolveColorNames(hues, state.count);

            for (let col = 0; col < state.count; col++) {
                const h = hues[col] % 360;
                const info = names[col];
                const fontSize = info.en.length > 10 ? 'text-[8px]' : 'text-[10px]';
                html += `<div class="text-center py-2 border-b border-slate-100 bg-white sticky top-0 z-10 flex flex-col justify-center h-14 overflow-hidden px-1">
                    <span class="text-xs font-bold text-slate-700 leading-tight truncate w-full" title="${info.ja}">${info.ja}</span>
                    <span class="${fontSize} font-medium text-slate-400 leading-tight truncate w-full" title="${info.en}">${info.en}</span>
                    <div class="text-[9px] font-normal text-slate-300 font-mono mt-0.5">${h.toFixed(0)}°</div>
                </div>`;
            }

            for (let row = 0; row < lSteps.length; row++) {
                const l = lSteps[row];
                const isBaseRow = (row === baseIndex);
                for (let col = 0; col < state.count; col++) {
                    const h = hues[col];
                    const bgStyle = `oklch(${l} ${state.c} ${h})`;
                    const isBaseCell = isBaseRow && col === 0;
                    const pinBtn = `
                        <button onclick="event.stopPropagation(); addToStock(${l}, ${state.c}, ${h})" class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 bg-white/20 hover:bg-white text-white hover:text-indigo-600 rounded p-0.5 transition-all z-20 backdrop-blur-sm" title="Stock">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                        </button>
                    `;

                    if (state.viewMode === 'fill') {
                        const isLight = l > 0.6;
                        const ringClass = isBaseCell ? "ring-4 ring-indigo-500 z-10 scale-105 shadow-lg" : "";
                        html += `
                        <div class="grid-cell h-12 sm:h-14 relative cursor-pointer group bg-slate-50 ${ringClass}" style="background-color: ${bgStyle};" onclick="copyColor(${l}, ${state.c}, ${h})">
                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><span class="bg-black/20 backdrop-blur-sm text-white text-[10px] font-bold px-1 rounded">Copy</span></div>
                            ${col === 0 ? `<div class="absolute left-1 top-1 text-[10px] font-bold ${isLight?'text-slate-800':'text-white'} opacity-60">L${(l*100).toFixed(0)}</div>` : ''}
                            ${pinBtn}
                        </div>`;
                    } else {
                        const isBgLight = state.bgTheme === 'light';
                        const bgClass = isBgLight ? 'bg-white' : 'bg-slate-900';
                        const activeBorder = isBaseCell ? 'border-indigo-500 border-2' : (isBgLight ? 'border border-slate-100' : 'border border-slate-800');
                        html += `
                        <div class="grid-cell h-12 sm:h-14 relative cursor-pointer group ${bgClass} ${activeBorder} flex items-center justify-center" onclick="copyColor(${l}, ${state.c}, ${h})">
                            <span style="color: ${bgStyle};" class="text-xl font-bold font-sans">Ag</span>
                            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/10 backdrop-blur-[1px]"><span class="bg-black/70 text-white text-[10px] font-bold px-1 rounded">Copy</span></div>
                            ${col === 0 ? `<div class="absolute left-1 top-1 text-[9px] font-bold text-slate-400">L${(l*100).toFixed(0)}</div>` : ''}
                            ${pinBtn}
                        </div>`;
                    }
                }
            }
            els.mainGrid.innerHTML = html;
            lucide.createIcons();
        }

        window.openCssModal = (scope) => {
            let css = ":root {\n";
            if (scope === 'grid') {
                css += "  /* --- Grid Colors --- */\n";
                const hueStep = 360 / state.count;
                const hues = []; for(let c=0; c<state.count; c++) hues.push((state.h + (c*hueStep)));
                const names = resolveColorNames(hues, state.count);
                for (let col = 0; col < state.count; col++) {
                    const h = hues[col] % 360;
                    const info = names[col];
                    let baseName = info.en.toLowerCase().replace(/\s+/g, '-');
                    const { steps, baseIndex } = generateLightnessSteps(state.l);
                    css += `  /* ${info.ja} / ${info.en} (Hue ${Math.round(h)}) */\n`;
                    steps.forEach((l, idx) => {
                        const suffix = 9 - idx;
                        const val = getFormattedColor(l, state.c, h, state.outputFormat);
                        css += `  --${baseName}-${suffix}: ${val};\n`;
                        if (idx === baseIndex) css += `  --${baseName}: ${val}; /* Base */\n`;
                    });
                    css += "\n";
                }
            }
            if (scope === 'stock') {
                if(pinnedColors.length > 0) {
                    css += "  /* --- Stock Colors --- */\n";
                    pinnedColors.forEach(c => {
                        const name = c.name.replace(/\s+/g, '-').toLowerCase();
                        const val = getFormattedColor(c.l, c.c, c.h, state.outputFormat);
                        css += `  --${name}: ${val};\n`;
                    });
                } else {
                    css += "  /* No pinned colors */\n";
                }
            }
            css += "}";
            els.cssOutput.value = css;
            els.cssModalTitle.textContent = scope === 'grid' ? 'CSS Output (Grid Only)' : 'CSS Output (Stock Only)';
            els.cssModal.classList.remove('hidden');
        };
        window.closeCssModal = () => els.cssModal.classList.add('hidden');
        window.copyCss = () => { els.cssOutput.select(); document.execCommand('copy'); const t=document.getElementById('toast'); t.textContent='Copied CSS!'; t.style.opacity='1'; setTimeout(()=>t.style.opacity='0',2000); };

        function syncUI() {
            // OKLCH Inputs
            els.inputL.value = state.l; els.numL.value = parseFloat(state.l).toFixed(3);
            els.inputC.value = state.c; els.numC.value = parseFloat(state.c).toFixed(3);
            els.inputH.value = state.h; els.numH.value = parseFloat(state.h).toFixed(1);
            
            // Text Displays
            const hh = state.h % 360; 
            const hNorm = hh < 0 ? hh + 360 : hh;
            const hex = rgbToHex(state.r, state.g, state.b);
            const hsl = rgbToHsl(state.r, state.g, state.b);
            const hsv = rgbToHsv(state.r, state.g, state.b);

            els.dispOklch.textContent = `${state.l.toFixed(3)} ${state.c.toFixed(3)} ${hNorm.toFixed(1)}`;
            els.dispHex.textContent = `#${hex}`;
            els.dispRgb.textContent = `${state.r}, ${state.g}, ${state.b}`;
            els.dispHsl.textContent = `${Math.round(hsl.h)}° ${Math.round(hsl.s)}% ${Math.round(hsl.l)}%`;
            els.dispHsv.textContent = `${Math.round(hsv.h)}° ${Math.round(hsv.s)}% ${Math.round(hsv.v)}%`;
            
            els.swatch.style.backgroundColor = `oklch(${state.l} ${state.c} ${state.h})`;

            // RGB Inputs
            if(document.activeElement !== els.inputHex) els.inputHex.value = hex;
            
            if(document.activeElement !== els.inputR && document.activeElement !== els.numR) { els.inputR.value = state.r; els.numR.value = state.r; }
            if(document.activeElement !== els.inputG && document.activeElement !== els.numG) { els.inputG.value = state.g; els.numG.value = state.g; }
            if(document.activeElement !== els.inputB && document.activeElement !== els.numB) { els.inputB.value = state.b; els.numB.value = state.b; }

            // HSL/HSV Inputs (avoid overwriting active inputs)
            if(!['input-hsl-h', 'num-hsl-h'].includes(document.activeElement?.id)) { els.inputHslH.value = Math.round(hsl.h); els.numHslH.value = Math.round(hsl.h); }
            if(!['input-hsl-s', 'num-hsl-s'].includes(document.activeElement?.id)) { els.inputHslS.value = Math.round(hsl.s); els.numHslS.value = Math.round(hsl.s); }
            if(!['input-hsl-l', 'num-hsl-l'].includes(document.activeElement?.id)) { els.inputHslL.value = Math.round(hsl.l); els.numHslL.value = Math.round(hsl.l); }

            if(!['input-hsv-h', 'num-hsv-h'].includes(document.activeElement?.id)) { els.inputHsvH.value = Math.round(hsv.h); els.numHsvH.value = Math.round(hsv.h); }
            if(!['input-hsv-s', 'num-hsv-s'].includes(document.activeElement?.id)) { els.inputHsvS.value = Math.round(hsv.s); els.numHsvS.value = Math.round(hsv.s); }
            if(!['input-hsv-v', 'num-hsv-v'].includes(document.activeElement?.id)) { els.inputHsvV.value = Math.round(hsv.v); els.numHsvV.value = Math.round(hsv.v); }

            // Mode Label logic ...
            if (state.count <= 8) {
                els.modeLabel.textContent = "基本名モード (〜8色)";
                els.modeLabel.className = "text-[10px] text-slate-500 mt-2 font-bold bg-blue-50 px-2 py-1 rounded inline-block w-full text-center border border-blue-100";
            } else if (state.count <= 15) {
                els.modeLabel.textContent = "詳細名モード (9〜15色)";
                els.modeLabel.className = "text-[10px] text-slate-500 mt-2 font-bold bg-indigo-50 px-2 py-1 rounded inline-block w-full text-center border border-indigo-100";
            } else {
                els.modeLabel.textContent = "複合名モード (16色〜)";
                els.modeLabel.className = "text-[10px] text-slate-500 mt-2 font-bold bg-purple-50 px-2 py-1 rounded inline-block w-full text-center border border-purple-100";
            }

            // Sync Mode Buttons Styles
            const currentCss = `oklch(${state.l} ${state.c} ${state.h})`;
            const isLight = state.l > 0.6;
            
            // 1. Fill Mode Button
            els.btnModeFill.style.backgroundColor = currentCss;
            els.btnModeFill.style.color = isLight ? '#1e293b' : '#ffffff'; 
            
            // 2. Text (Light) Button
            els.btnModeLight.style.color = currentCss;
            
            // 3. Text (Dark) Button
            els.btnModeDark.style.color = currentCss;

            // Active State
            const activeClass = "ring-2 ring-indigo-500 ring-offset-2 z-10 border-transparent";
            
            els.btnModeFill.className = `rounded-lg border text-xs font-bold shadow-sm transition-all flex flex-col items-center justify-center leading-tight ${state.viewMode === 'fill' ? activeClass : 'border-slate-200'}`;
            els.btnModeLight.className = `bg-white rounded-lg border text-xs font-bold shadow-sm transition-all flex flex-col items-center justify-center leading-tight ${state.viewMode === 'text' && state.bgTheme === 'light' ? activeClass : 'border-slate-200'}`;
            els.btnModeDark.className = `bg-slate-900 rounded-lg border text-xs font-bold shadow-sm transition-all flex flex-col items-center justify-center leading-tight ${state.viewMode === 'text' && state.bgTheme === 'dark' ? activeClass : 'border-slate-700'}`;

            updateSliderGradients();
            renderGrid();
            renderStock();
        }

        // Event Listeners
        [els.inputL, els.numL].forEach(el => el.addEventListener('input', () => updateState(el.value, state.c, state.h)));
        [els.inputC, els.numC].forEach(el => el.addEventListener('input', () => updateState(state.l, el.value, state.h)));
        [els.inputH, els.numH].forEach(el => el.addEventListener('input', () => updateState(state.l, state.c, el.value)));

        [els.inputR, els.numR].forEach(el => el.addEventListener('input', () => updateStateFromRgb(el.value, state.g, state.b)));
        [els.inputG, els.numG].forEach(el => el.addEventListener('input', () => updateStateFromRgb(state.r, el.value, state.b)));
        [els.inputB, els.numB].forEach(el => el.addEventListener('input', () => updateStateFromRgb(state.r, state.g, el.value)));

        // HSL / HSV Listeners
        const getHslInput = () => [els.inputHslH.value, els.inputHslS.value, els.inputHslL.value];
        [els.inputHslH, els.numHslH, els.inputHslS, els.numHslS, els.inputHslL, els.numHslL].forEach(el => {
            el.addEventListener('input', () => {
                const [h, s, l] = getHslInput();
                updateStateFromHsl(h, s, l);
            });
        });

        const getHsvInput = () => [els.inputHsvH.value, els.inputHsvS.value, els.inputHsvV.value];
        [els.inputHsvH, els.numHsvH, els.inputHsvS, els.numHsvS, els.inputHsvV, els.numHsvV].forEach(el => {
            el.addEventListener('input', () => {
                const [h, s, v] = getHsvInput();
                updateStateFromHsv(h, s, v);
            });
        });

        els.inputHex.addEventListener('input', (e) => {
            let hex = e.target.value; if(hex.startsWith('#')) hex=hex.slice(1);
            if(hex.length===3) hex=hex.split('').map(c=>c+c).join('');
            if(hex.length===6) {
                const r=parseInt(hex.substring(0,2),16), g=parseInt(hex.substring(2,4),16), b=parseInt(hex.substring(4,6),16);
                if(!isNaN(r)) updateStateFromRgb(r,g,b);
            }
        });
        const updateCount = (n) => { 
            state.count = Math.max(3, Math.min(36, parseInt(n))); 
            saveToLocal();
            syncUI(); 
        };
        els.inputCount.addEventListener('change', (e) => updateCount(e.target.value));
        els.btnInc.addEventListener('click', () => updateCount(state.count + 1));
        els.btnDec.addEventListener('click', () => updateCount(state.count - 1));

        els.btnGen.addEventListener('click', async () => {
            if (!apiKey) { els.errAi.textContent = "API Key not set."; els.errAi.classList.remove('hidden'); return; }
            const theme = els.inputTheme.value; if (!theme) return;
            els.btnGen.classList.add('loading'); els.aiWrapper.classList.add('hidden'); els.errAi.classList.add('hidden');
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Generate 5 OKLCH colors for theme "${theme}". Output JSON array: [{"l":0.5,"c":0.1,"h":0,"label":"name"}]` }] }] })
                });
                if(!res.ok) throw new Error("API Error");
                const data = await res.json();
                const colors = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim());
                els.pAi.innerHTML = colors.map(c => {
                    const css = `oklch(${c.l} ${c.c} ${c.h})`;
                    return `<div class="w-24 h-24 rounded-lg shadow-sm flex flex-col overflow-hidden cursor-pointer hover:scale-105 transition-transform" onclick="setBaseColor(${c.l}, ${c.c}, ${c.h})">
                        <div class="flex-1" style="background:${css}"></div>
                        <div class="bg-white p-1 text-[10px] text-center truncate font-bold border-t border-slate-100">${c.label}</div>
                    </div>`;
                }).join('');
                els.aiWrapper.classList.remove('hidden');
            } catch(e) { els.errAi.textContent = "Error generating palette."; els.errAi.classList.remove('hidden'); }
            finally { els.btnGen.classList.remove('loading'); }
        });

        loadFromLocal();
    </script>
</body>
</html>